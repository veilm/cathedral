<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>cathedral</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&display=swap" rel="stylesheet">

<link
	rel="icon"
	href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üóùÔ∏è</text></svg>"
>

<style>
:root{
  --bg:#1a1816;
  --ink:#d4cfc7;
  --user:#9b8e7f;
  --rule:#3a3530;
  --accent:#6b635a;
  --gold:#8b7355;
  --table-border:#2f2b27;
  font-size:17px;
  line-height:1.7;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  /* Subtle radial gradient - like candlelight on stone */
  /*
  background:radial-gradient(ellipse at center top, #1f1d1a 0%, var(--bg) 50%);
  */
  
  /* Alternative gradients - uncomment to try: */
  
  /* Vespers light - vertical dawn/dusk */
  /* background:linear-gradient(180deg, #1e1c19 0%, var(--bg) 20%, var(--bg) 80%, #16140f 100%); */
  
  /* Cathedral depth - diagonal with warm undertone */
  /* background:linear-gradient(135deg, #1c1917 0%, var(--bg) 40%, #181513 100%); */
  
  /* Stone texture - multiple layers for depth */
  /* background:
    radial-gradient(circle at 20% 50%, rgba(139, 115, 85, 0.02) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(107, 99, 90, 0.02) 0%, transparent 50%),
    var(--bg); */
  
  /* Combined warmth - radial candlelight + diagonal depth */
  background:
    radial-gradient(ellipse at center top, rgba(31, 29, 26, 0.8) 0%, transparent 50%),
    linear-gradient(135deg, #1c1917 0%, var(--bg) 40%, #181513 100%);
  
  color:var(--ink);
  font-family:"Crimson Text","Garamond",serif;
  display:flex;
  flex-direction:column;
  height:100vh;
  padding:0 clamp(1rem, 4vw, 4rem);
}
header{
  flex-shrink:0;
  padding:1.8rem 0 1.2rem;
  border-bottom:1px solid var(--rule);
  font-size:.85rem;
  color:var(--accent);
  letter-spacing:0.15em;
}
main{
  flex:1 1 auto;
  overflow:auto;
  padding:2.5rem 0;
}
.message{
  max-width:42rem;
  margin:0 auto 1.8rem;
  position:relative;
}
.user .text{
  font-weight:300;
  font-size:0.95em;
  margin-left:1.2rem;
  text-indent:-0.4rem;
  color:var(--user);
}
.collapsed{
  max-height:4em;
  overflow:hidden;
}
.expand{
  position:absolute;
  bottom:.1rem;
  right:0;
  background:0;
  border:0;
  color:var(--accent);
  font-size:.75rem;
  cursor:pointer;
  padding:.2rem .4rem;
  border-radius:2px;
  opacity:0.7;
}
.expand:hover{
  background:#ffffff08;
  opacity:1;
}
hr{
  border:0;
  border-top:1px solid var(--rule);
  margin:2rem auto;
  max-width:42rem;
  position:relative;
}
hr::after{
  content:"‚ú¶";
  position:absolute;
  top:-0.65em;
  left:50%;
  transform:translateX(-50%);
  background:var(--bg);
  padding:0 0.5em;
  color:var(--gold);
  font-size:0.8em;
}
footer{
  flex-shrink:0;
  padding:1.4rem 0 2.2rem;
  display:flex;
  gap:.8rem;
  align-items:center;
  justify-content:center;
}
textarea{
  flex:1;
  max-width:42rem;
  border:0;
  background:#ffffff04;
  color:var(--ink);
  font:inherit;
  resize:none;
  outline:none;
  min-height:2.8rem;
  padding:0.6rem 0.8rem;
  border-radius:3px;
}
textarea::placeholder{
  color:var(--accent);
  opacity:0.6;
}
#settings{
  position:fixed;
  bottom:1.4rem;
  right:1.6rem;
  width:48px;
  height:48px;
  cursor:pointer;
  opacity:.4;
  transition:opacity .3s;
  background:transparent;
  border:0;
  padding:0;
}
#settings:hover{opacity:.7;}
#settings:focus{
  outline:1px solid var(--gold);
  outline-offset:2px;
  opacity:.6;
}
#settings svg{
  width:100%;
  height:100%;
}
@keyframes spin-slow{
  from{transform:rotate(0deg);}
  to{transform:rotate(360deg);}
}
@keyframes spin-fast{
  from{transform:rotate(0deg);}
  to{transform:rotate(-360deg);}
}

/* settings menu */
.settings-menu{
  position:fixed;
  bottom:4.5rem;
  right:1.6rem;
  background:var(--bg);
  border:1px solid var(--rule);
  border-radius:3px;
  padding:0.5rem;
  opacity:0;
  visibility:hidden;
  transition:opacity 0.2s, visibility 0.2s;
}
.settings-menu.open{
  opacity:1;
  visibility:visible;
}
.settings-menu button{
  display:block;
  width:100%;
  padding:0.5rem 0.8rem;
  background:transparent;
  border:0;
  color:var(--ink);
  font:inherit;
  font-size:0.85rem;
  text-align:left;
  cursor:pointer;
  border-radius:2px;
  transition:background 0.15s;
}
.settings-menu button:hover{
  background:#ffffff08;
  color:var(--gold);
}

/* loading animation */
.loading{
  display:inline-block;
  opacity:0.6;
  animation:pulse 1.5s ease-in-out infinite;
}
.loading::after{
  content:"¬∑¬∑¬∑";
  display:inline-block;
  animation:dots 1.5s steps(3, end) infinite;
}
@keyframes pulse{
  0%,100%{opacity:0.4;}
  50%{opacity:0.8;}
}
@keyframes dots{
  0%{content:"¬∑";}
  33%{content:"¬∑¬∑";}
  66%{content:"¬∑¬∑¬∑";}
}

/* cathedral table styling */
.scripture-table{
  margin:2rem auto;
  max-width:38rem;
  border-collapse:separate;
  border-spacing:0;
  font-size:0.9em;
}
.scripture-table th,
.scripture-table td{
  padding:0.8rem 1rem;
  text-align:left;
  border-bottom:1px solid var(--table-border);
}
.scripture-table th{
  color:var(--gold);
  font-weight:400;
  letter-spacing:0.1em;
  text-transform:uppercase;
  font-size:0.8em;
}
.scripture-table tr:last-child td{
  border-bottom:none;
}
.scripture-table td:first-child{
  color:var(--accent);
  font-style:italic;
}
</style>
</head>
<body>
<header>cathedral</header>

<main id="chat">
  <div class="message">
    <p class="text">
      In this quiet hall, words echo differently. 
      Stone remembers what was spoken, and silence holds its own weight.
      Share what moves through your mind‚Äîbrief meditation or lengthy contemplation.
    </p>
  </div>
  
  <table class="scripture-table">
    <thead>
      <tr>
        <th>Hour</th>
        <th>Office</th>
        <th>Silence</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Dawn</td>
        <td>Lauds</td>
        <td>Breaking</td>
      </tr>
      <tr>
        <td>Third</td>
        <td>Terce</td>
        <td>Working</td>
      </tr>
      <tr>
        <td>Ninth</td>
        <td>None</td>
        <td>Resting</td>
      </tr>
      <tr>
        <td>Evening</td>
        <td>Vespers</td>
        <td>Gathering</td>
      </tr>
      <tr>
        <td>Night</td>
        <td>Compline</td>
        <td>Complete</td>
      </tr>
    </tbody>
  </table>
</main>

<footer>
  <textarea placeholder="speak into the stone‚Ä¶" rows="1"></textarea>
</footer>

<button id="settings" aria-label="Settings" role="button">
  <svg viewBox="0 0 24 24">
    <!-- <polygon points="12,7 16.33,14.5 7.67,14.5" fill="none" stroke="#6b635a" stroke-width="0.7" opacity="0.5" style="animation: spin-fast 8s linear infinite; transform-origin: center;"/> -->

    <polygon points="12,4 19,16 5,16" fill="none" stroke="#8b7355" stroke-width="0.8" opacity="0.8" style="animation: spin-slow 12s linear infinite; transform-origin: center;"/>
    <!-- <polygon points="12,4 19,16 5,16" fill="none" stroke="#deb887" stroke-width="0.8" opacity="0.8" style="animation: spin-fast 16s linear infinite; transform-origin: center;"/> -->
    <polygon points="12,4 19,16 5,16" fill="none" stroke="#6b635a" stroke-width="0.7" opacity="0.5" style="animation: spin-fast 8s linear infinite; transform-origin: center;"/>
  </svg>
</button>

<nav class="settings-menu" role="navigation" aria-label="Settings menu">
  <button onclick="newConversation()">New Conversation</button>
</nav>

<script>
/* ---------- expand/collapse ---------- */
function maybeCollapse(p){
  if(p.scrollHeight > 4 * parseFloat(getComputedStyle(p).fontSize)){
    p.classList.add('collapsed');
    const btn=document.createElement('button');
    btn.className='expand';
    btn.textContent='¬∑¬∑¬∑';
    btn.onclick=()=>{
      p.classList.toggle('collapsed');
      btn.textContent = p.classList.contains('collapsed') ? '¬∑¬∑¬∑' : '‚Üë';
    };
    p.parentNode.appendChild(btn);
  }
}
document.querySelectorAll('.text').forEach(maybeCollapse);

/* ---------- settings menu ---------- */
const settingsBtn = document.getElementById('settings');
const settingsMenu = document.querySelector('.settings-menu');

settingsBtn.addEventListener('click', () => {
  settingsMenu.classList.toggle('open');
});

document.addEventListener('click', (e) => {
  if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
    settingsMenu.classList.remove('open');
  }
});

async function newConversation() {
  try {
    const response = await fetch('/api/new-conversation', {
      method: 'POST'
    });

    if (!response.ok) {
      throw new Error('Failed to create new conversation');
    }

    const data = await response.json();

    // Redirect to the new conversation
    window.location.href = data.url;
  } catch (error) {
    console.error('Failed to create new conversation:', error);
    alert('Failed to create new conversation. Please try again.');
  }
}

async function loadConversation(conversationId) {
  try {
    const response = await fetch(`/api/conversation/${conversationId}`);

    if (!response.ok) {
      throw new Error('Conversation not found');
    }

    const data = await response.json();
    const chat = document.getElementById('chat');

    // Clear current content
    chat.innerHTML = '';

    // Add messages
    for (const msg of data.messages) {
      const div = document.createElement('div');
      div.className = msg.role === 'user' ? 'message user' : 'message';
      div.innerHTML = `<p class="text">${escapeHtml(msg.content)}</p>`;
      chat.appendChild(div);
      maybeCollapse(div.querySelector('p'));
    }

    // If no messages, show the default content
    if (data.messages.length === 0) {
      chat.innerHTML = `
        <div class="message">
          <p class="text">
            In this quiet hall, words echo differently.
            Stone remembers what was spoken, and silence holds its own weight.
            Share what moves through your mind‚Äîbrief meditation or lengthy contemplation.
          </p>
        </div>

        <table class="scripture-table">
          <thead>
            <tr>
              <th>Hour</th>
              <th>Office</th>
              <th>Silence</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Dawn</td>
              <td>Lauds</td>
              <td>Breaking</td>
            </tr>
            <tr>
              <td>Third</td>
              <td>Terce</td>
              <td>Working</td>
            </tr>
            <tr>
              <td>Ninth</td>
              <td>None</td>
              <td>Resting</td>
            </tr>
            <tr>
              <td>Evening</td>
              <td>Vespers</td>
              <td>Gathering</td>
            </tr>
            <tr>
              <td>Night</td>
              <td>Compline</td>
              <td>Complete</td>
            </tr>
          </tbody>
        </table>
      `;
    }
  } catch (error) {
    console.error('Failed to load conversation:', error);
    // Show error message
    const chat = document.getElementById('chat');
    chat.innerHTML = `
      <div class="message">
        <p class="text" style="color: var(--gold);">
          The conversation has been lost to time.
        </p>
      </div>
    `;
  }
}

/* ---------- minimal chat loop ---------- */
const chat=document.getElementById('chat');
const ta=document.querySelector('textarea');
let currentConversationId = null;

const escapeHtml = (text) => {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
};

const send=async()=>{
  const val=ta.value.trim();
  if(!val)return;

  // Ensure we have a conversation ID
  if(!currentConversationId) {
    // Create new conversation if none exists
    try {
      const response = await fetch('/api/new-conversation', { method: 'POST' });
      const data = await response.json();
      currentConversationId = data.id;
      window.history.pushState({}, '', `/c/${currentConversationId}`);
    } catch (error) {
      console.error('Failed to create conversation:', error);
      return;
    }
  }

  // Add user message
  const div=document.createElement('div');
  div.className='message user';
  div.innerHTML=`<p class="text">${escapeHtml(val)}</p>`;
  chat.appendChild(div);
  maybeCollapse(div.querySelector('p'));

  // Add loading indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'message';
  loadingDiv.innerHTML = '<p class="text"><span class="loading"></span></p>';
  chat.appendChild(loadingDiv);
  loadingDiv.scrollIntoView({behavior:'smooth'});

  // Clear input immediately for better UX
  ta.value='';
  ta.disabled = true;

  try {
    // Send to backend API with conversation ID
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: val,
        conversation_id: currentConversationId
      })
    });

    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}`);
    }

    const data = await response.json();

    // Remove loading indicator
    loadingDiv.remove();

    // Add server response to UI
    const reply=document.createElement('div');
    reply.className='message';
    reply.innerHTML=`<p class="text">${escapeHtml(data.response)}</p>`;
    chat.appendChild(reply);
    maybeCollapse(reply.querySelector('p'));
    reply.scrollIntoView({behavior:'smooth'});

  } catch (error) {
    console.error('Chat error:', error);

    // Remove loading indicator
    loadingDiv.remove();

    // Show error message
    const reply=document.createElement('div');
    reply.className='message';
    reply.innerHTML=`<p class="text" style="color: var(--gold);">
      The stones are silent. The connection to cathedral has been lost.
      Please try again later.
    </p>`;
    chat.appendChild(reply);
    reply.scrollIntoView({behavior:'smooth'});
  } finally {
    ta.disabled = false;
    ta.focus();
  }
};
ta.addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault();send();}
});

// Check if we're viewing a specific conversation
window.addEventListener('DOMContentLoaded', () => {
  const path = window.location.pathname;
  if (path.startsWith('/c/')) {
    const conversationId = path.substring(3); // Remove '/c/' prefix
    if (conversationId) {
      currentConversationId = conversationId;
      loadConversation(conversationId);
    }
  }
});
</script>
</body>
</html>
